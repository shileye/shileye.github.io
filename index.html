<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>乐哥OJ AC记录系统 </title>
    <!-- 引入外部库 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        /* --- CSS 美化区 --- */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');

        :root {
            --light-bg: #f0f2f5;
            --light-card-bg: rgba(255, 255, 255, 0.65);
            --light-text: #333;
            --light-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --light-border: rgba(255, 255, 255, 0.2);
            --dark-bg: #1a1a2e;
            --dark-card-bg: rgba(26, 26, 46, 0.55);
            --dark-text: #e0e0e0;
            --dark-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
            --dark-border: rgba(255, 255, 255, 0.1);
            --primary-glow: 0 0 15px rgba(13, 110, 253, 0.5);
            --border-radius: 12px;
        }

        [data-theme="light"] {
            --bg-color: var(--light-bg);
            --card-bg-color: var(--light-card-bg);
            --text-color: var(--light-text);
            --shadow-color: var(--light-shadow);
            --border-color: var(--light-border);
        }
        [data-theme="dark"] {
            --bg-color: var(--dark-bg);
            --card-bg-color: var(--dark-card-bg);
            --text-color: var(--dark-text);
            --shadow-color: var(--dark-shadow);
            --border-color: var(--dark-border);
            --bs-body-color: var(--dark-text);
            --bs-body-bg: var(--bg-color);
            --bs-tertiary-bg: var(--dark-card-bg);
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            z-index: -1;
            top: 0;
            left: 0;
        }

        .card {
            background: var(--card-bg-color);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-color);
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        
        .main-title {
            animation: text-pop-up-top 0.5s cubic-bezier(0.250, 0.460, 0.450, 0.940) both;
        }

        .btn { border-radius: 20px; font-weight: 500; }
        .btn-primary { box-shadow: var(--primary-glow); }
        
        .progress-bar {
            background: linear-gradient(90deg, rgba(131,58,180,1) 0%, rgba(253,29,29,1) 50%, rgba(252,176,69,1) 100%);
        }

        /* 日历热力图样式 */
        .heatmap-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(14px, 1fr)); gap: 3px; }
        .heatmap-day { width: 14px; height: 14px; background-color: #ebedf0; border-radius: 2px; }
        [data-theme="dark"] .heatmap-day { background-color: rgba(255,255,255,0.1); }
        .heatmap-day[data-level="1"] { background-color: #9be9a8; }
        .heatmap-day[data-level="2"] { background-color: #40c463; }
        .heatmap-day[data-level="3"] { background-color: #30a14e; }
        .heatmap-day[data-level="4"] { background-color: #216e39; }
        .tooltip-inner { font-size: 12px; }

        .theme-switch {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        @keyframes text-pop-up-top {
            0% { transform: translateY(0); opacity: 0; }
            100% { transform: translateY(-10px); opacity: 1; }
        }
    </style>
</head>
<body data-theme="light">

    <div id="particles-js"></div>

    <div class="container py-4">
        <!-- 标题和模式切换 -->
        <div class="d-flex justify-content-center align-items-center mb-4">
            <h1 class="main-title text-center"><i class="bi bi-trophy-fill"></i> 乐哥OJ AC记录系统 </h1>
        </div>

        <!-- 主控制区 -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3 align-items-center">
                    <div class="col-lg-4"><input type="date" id="datePicker" class="form-control"></div>
                    <div class="col-lg-8 text-lg-end">
                        <button id="todayBtn" class="btn btn-outline-primary btn-sm"><i class="bi bi-calendar-check"></i> 今天</button>
                        <button id="saveBtn" class="btn btn-success btn-sm"><i class="bi bi-check-circle-fill"></i> 保存</button>
                        <button id="showChartBtn" class="btn btn-info btn-sm"><i class="bi bi-pie-chart-fill"></i> 分布</button>
                        <button class="btn btn-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#ioCollapse"><i class="bi bi-gear-fill"></i> 导入/导出</button>
                    </div>
                </div>
                <div class="collapse mt-3" id="ioCollapse">
                    <div class="d-flex gap-2">
                        <button id="exportBtn" class="btn btn-outline-success btn-sm"><i class="bi bi-download"></i> 导出JSON</button>
                        <input type="file" id="importFile" accept=".json" style="display: none;">
                        <button id="importBtn" class="btn btn-outline-info btn-sm"><i class="bi bi-upload"></i> 导入JSON</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 目标进度条 -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="card-title mb-0">本周目标</h5>
                    <div>
                        <span id="weeklyProgressText">0 / 10</span>
                        <button id="editGoalBtn" class="btn btn-sm btn-link p-0 ms-2"><i class="bi bi-pencil-square"></i></button>
                    </div>
                </div>
                <div class="progress" style="height: 10px;">
                    <div id="weeklyProgressBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>

        <!-- 平台区 -->
        <div id="platformsContainer" class="row"></div>

        <!-- 日历热力图 -->
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">刷题日历</h5>
                <div id="heatmapContainer" class="heatmap-container"></div>
            </div>
        </div>
        
        <!-- AC趋势图 -->
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">最近7天AC趋势</h5>
                <canvas id="acChart"></canvas>
            </div>
        </div>
        
        <!-- 历史记录 -->
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">历史记录</h5>
                <nav><ul id="historyPagination" class="pagination pagination-sm justify-content-end"></ul></nav>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead><tr><th>日期</th><th>牛客</th><th>HDU</th><th>VJ</th><th>洛谷</th><th>AtCoder</th><th>CF</th><th>力扣</th><th>总计</th><th>详情</th></tr></thead>
                        <tbody id="historyTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 主题切换按钮 -->
    <div class="theme-switch">
        <button id="themeToggleBtn" class="btn btn-dark"><i class="bi bi-moon-stars-fill"></i></button>
    </div>

    <!-- Modals (弹窗) -->
    <div class="modal fade" id="problemModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="modalTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="currentPlatform"><div class="mb-3"><input type="text" class="form-control" id="problemId" placeholder="题目编号 (如: 1A)"></div><div class="mb-3"><input type="text" class="form-control" id="problemName" placeholder="题目名称"></div><div class="mb-3"><select class="form-select" id="problemDifficulty"><option>简单</option><option>中等</option><option>困难</option></select></div><h6>已添加题目：</h6><div id="currentProblemList" class="list-group"></div></div><div class="modal-footer"><button type="button" id="addProblemBtn" class="btn btn-primary">添加</button></div></div></div></div>
    <div class="modal fade" id="detailModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="detailTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="detailContent"></div></div></div></div>
    <div class="modal fade" id="chartModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">各平台题目数量分布</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><canvas id="platformChart"></canvas></div></div></div></div>

    <!-- 引入 JS 库 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    
    <script>
        // --- JavaScript 逻辑区 ---
        document.addEventListener('DOMContentLoaded', () => {

            const OJ_Tracker = {
                state: {
                    records: [],
                    weeklyGoal: 10,
                    currentProblems: {},
                    acChartInstance: null,
                    platformChartInstance: null,
                    currentPage: 1,
                    recordsPerPage: 7,
                    currentTheme: 'light',
                },

                platforms: {
                    'nowcoder': { name: '牛客', color: '#40a9ff' },
                    'hduoj': { name: 'HDU', color: '#ff7a45' },
                    'vj': { name: 'VJ', color: '#73d13d' },
                    'luogu': { name: '洛谷', color: '#9254de' },
                    'atcoder': { name: 'AtCoder', color: '#ff4d4f' },
                    'codeforces': { name: 'CF', color: '#597ef7' },
                    'leetcode': { name: '力扣', color: '#ffc53d' }
                },

                elements: {
                    body: document.body,
                    datePicker: document.getElementById('datePicker'),
                    platformsContainer: document.getElementById('platformsContainer'),
                    historyTableBody: document.getElementById('historyTableBody'),
                    historyPagination: document.getElementById('historyPagination'),
                    // Modals
                    problemModalEl: document.getElementById('problemModal'),
                    detailModalEl: document.getElementById('detailModal'),
                    chartModalEl: document.getElementById('chartModal'),
                    modalTitle: document.getElementById('modalTitle'),
                    currentPlatformInput: document.getElementById('currentPlatform'),
                    problemIdInput: document.getElementById('problemId'),
                    problemNameInput: document.getElementById('problemName'),
                    problemDifficultySelect: document.getElementById('problemDifficulty'),
                    currentProblemList: document.getElementById('currentProblemList'),
                    detailTitle: document.getElementById('detailTitle'),
                    detailContent: document.getElementById('detailContent'),
                    platformChartCanvas: document.getElementById('platformChart'),
                    acChartCanvas: document.getElementById('acChart'),
                    // Progress
                    weeklyProgressBar: document.getElementById('weeklyProgressBar'),
                    weeklyProgressText: document.getElementById('weeklyProgressText'),
                    // Heatmap
                    heatmapContainer: document.getElementById('heatmapContainer'),
                },
                
                init() {
                    this.loadData();
                    this.initModals();
                    this.initParticles();
                    this.renderPlatformInputs();
                    this.bindEvents();
                    
                    this.elements.datePicker.valueAsDate = new Date();
                    this.loadRecordForDate();
                    this.updateAllUI();
                    this.setTheme(this.state.currentTheme);
                },

                initModals() {
                    this.problemModal = new bootstrap.Modal(this.elements.problemModalEl);
                    this.detailModal = new bootstrap.Modal(this.elements.detailModalEl);
                    this.chartModal = new bootstrap.Modal(this.elements.chartModalEl);
                },

                bindEvents() {
                    document.getElementById('todayBtn').addEventListener('click', () => {
                        this.elements.datePicker.valueAsDate = new Date();
                        this.loadRecordForDate();
                    });
                    document.getElementById('saveBtn').addEventListener('click', e => this.saveRecord(e.target));
                    document.getElementById('showChartBtn').addEventListener('click', () => {
                        this.chartModal.show();
                        this.renderPlatformPieChart();
                    });
                    this.elements.datePicker.addEventListener('change', () => this.loadRecordForDate());
                    document.getElementById('addProblemBtn').addEventListener('click', () => this.addProblem());
                    document.getElementById('themeToggleBtn').addEventListener('click', () => this.toggleTheme());
                    document.getElementById('editGoalBtn').addEventListener('click', () => this.editWeeklyGoal());
                    document.getElementById('exportBtn').addEventListener('click', () => this.exportData());
                    document.getElementById('importBtn').addEventListener('click', () => this.elements.importFile.click());
                    document.getElementById('importFile').addEventListener('change', e => this.importData(e));

                    this.elements.platformsContainer.addEventListener('click', e => {
                        const target = e.target.closest('.btn-add-problem');
                        if(target) this.openProblemModal(target.dataset.platformId);
                    });
                    this.elements.currentProblemList.addEventListener('click', e => {
                        const target = e.target.closest('.btn-remove-problem');
                        if (target) this.removeProblem(target.dataset.platformId, parseInt(target.dataset.index));
                    });
                    this.elements.historyTableBody.addEventListener('click', e => {
                        const target = e.target.closest('.btn-show-detail');
                        if (target) this.showProblemDetail(target.dataset.date);
                    });
                    this.elements.historyPagination.addEventListener('click', e => {
                        e.preventDefault();
                        const target = e.target.closest('.page-link');
                        if (target?.dataset.page) {
                            this.state.currentPage = parseInt(target.dataset.page);
                            this.renderHistoryTable();
                        }
                    });
                },

                saveData() {
                    const dataToSave = {
                        records: this.state.records,
                        weeklyGoal: this.state.weeklyGoal,
                        theme: this.state.currentTheme
                    };
                    localStorage.setItem('acRecords_v3', JSON.stringify(dataToSave));
                },

                loadData() {
                    const data = JSON.parse(localStorage.getItem('acRecords_v3'));
                    if (data) {
                        this.state.records = data.records || [];
                        this.state.weeklyGoal = data.weeklyGoal || 10;
                        this.state.currentTheme = data.theme || 'light';
                    }
                },

                renderPlatformInputs() {
                    this.elements.platformsContainer.innerHTML = Object.entries(this.platforms).map(([id, p]) => `
                        <div class="col-6 col-md-4 col-lg-3 mb-3">
                            <div class="card platform-card" style="border-top-color: ${p.color};">
                                <div class="card-body">
                                    <h6 class="card-title">${p.name}</h6>
                                    <div class="input-group">
                                        <input type="number" min="0" id="${id}Input" class="form-control" value="0">
                                        <button class="btn btn-outline-secondary btn-add-problem" type="button" data-platform-id="${id}"><i class="bi bi-plus-lg"></i></button>
                                    </div>
                                    <div id="${id}ProblemList" class="mt-2 small text-muted"></div>
                                </div>
                            </div>
                        </div>`).join('');
                },
                
                openProblemModal(platformId) {
                    this.elements.currentPlatformInput.value = platformId;
                    this.elements.problemIdInput.value = '';
                    this.elements.problemNameInput.value = '';
                    this.elements.problemDifficultySelect.value = '中等';
                    this.renderCurrentProblemList(platformId);
                    this.elements.modalTitle.textContent = `添加 ${this.platforms[platformId].name} 题目`;
                    this.problemModal.show();
                },

                renderCurrentProblemList(platformId) {
                    const problems = this.state.currentProblems[platformId] || [];
                    this.elements.currentProblemList.innerHTML = (problems.length === 0)
                        ? '<div class="list-group-item text-center text-muted">暂无题目</div>'
                        : problems.map((p, i) => `
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div><small class="fw-bold">${p.id}:</small> ${p.name} <span class="badge bg-secondary ms-2">${p.difficulty}</span></div>
                                <button class="btn btn-sm btn-outline-danger btn-remove-problem" data-platform-id="${platformId}" data-index="${i}"><i class="bi bi-trash"></i></button>
                            </div>`).join('');
                },

                addProblem() {
                    const platformId = this.elements.currentPlatformInput.value;
                    const id = this.elements.problemIdInput.value.trim();
                    const name = this.elements.problemNameInput.value.trim();
                    const difficulty = this.elements.problemDifficultySelect.value;
                    if (!id || !name) { alert('请输入题目编号和名称'); return; }
                    
                    if (!this.state.currentProblems[platformId]) this.state.currentProblems[platformId] = [];
                    this.state.currentProblems[platformId].push({ id, name, difficulty });

                    this.renderCurrentProblemList(platformId);
                    this.updatePlatformProblemList(platformId);
                    document.getElementById(`${platformId}Input`).value = this.state.currentProblems[platformId].length;
                    
                    this.elements.problemIdInput.value = '';
                    this.elements.problemNameInput.value = '';
                    this.elements.problemIdInput.focus();
                },

                removeProblem(platformId, index) {
                    this.state.currentProblems[platformId]?.splice(index, 1);
                    this.renderCurrentProblemList(platformId);
                    this.updatePlatformProblemList(platformId);
                    document.getElementById(`${platformId}Input`).value = this.state.currentProblems[platformId]?.length || 0;
                },

                updatePlatformProblemList(platformId) {
                    const container = document.getElementById(`${platformId}ProblemList`);
                    const problems = this.state.currentProblems[platformId] || [];
                    container.textContent = problems.length > 0 ? `已记录 ${problems.length} 题` : '';
                },
                
                saveRecord(saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 保存中...';

                    const date = this.elements.datePicker.value;
                    if (!date) { alert('请选择日期'); return; }
                    
                    const record = { date, counts: {}, problems: { ...this.state.currentProblems } };
                    let total = 0;
                    Object.keys(this.platforms).forEach(id => {
                        const count = parseInt(document.getElementById(`${id}Input`).value) || 0;
                        record.counts[id] = count;
                        total += count;
                    });

                    const index = this.state.records.findIndex(r => r.date === date);
                    if (index >= 0) this.state.records[index] = record;
                    else this.state.records.push(record);
                    
                    this.state.records.sort((a, b) => new Date(a.date) - new Date(b.date));
                    this.saveData();
                    this.updateAllUI();

                    setTimeout(() => {
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = '<i class="bi bi-check-circle-fill"></i> 保存';
                        alert(`保存成功！共 ${total} 题`);
                    }, 500);
                },

                loadRecordForDate() {
                    const date = this.elements.datePicker.value;
                    const record = this.state.records.find(r => r.date === date);
                    this.state.currentProblems = record ? JSON.parse(JSON.stringify(record.problems || {})) : {};

                    Object.keys(this.platforms).forEach(id => {
                        document.getElementById(`${id}Input`).value = record?.counts?.[id] || 0;
                        this.updatePlatformProblemList(id);
                    });
                },
                
                renderHistoryTable() {
                    const startIndex = (this.state.currentPage - 1) * this.state.recordsPerPage;
                    const pageRecords = this.state.records.slice().reverse().slice(startIndex, startIndex + this.state.recordsPerPage);
                    
                    this.elements.historyTableBody.innerHTML = pageRecords.map(record => {
                        let total = 0;
                        const platformCells = Object.keys(this.platforms).map(id => {
                            const count = record.counts?.[id] || 0;
                            total += count;
                            return `<td>${count}</td>`;
                        }).join('');
                        return `<tr><td>${record.date}</td>${platformCells}<td><strong>${total}</strong></td><td><button class="btn btn-sm btn-outline-info btn-show-detail" data-date="${record.date}">查看</button></td></tr>`;
                    }).join('');
                    this.renderPagination();
                },

                renderPagination() {
                    const totalPages = Math.ceil(this.state.records.length / this.state.recordsPerPage);
                    if(totalPages <= 1) { this.elements.historyPagination.innerHTML = ''; return; }
                    this.elements.historyPagination.innerHTML = Array.from({length: totalPages}, (_, i) => 
                        `<li class="page-item ${i + 1 === this.state.currentPage ? 'active' : ''}"><a class="page-link" href="#" data-page="${i + 1}">${i + 1}</a></li>`
                    ).join('');
                },

                showProblemDetail(date) {
                    const record = this.state.records.find(r => r.date === date);
                    if (!record) return;
                    
                    let content = '';
                    let hasProblems = false;
                    Object.entries(this.platforms).forEach(([id, p]) => {
                        const problems = record.problems?.[id] || [];
                        if (problems.length === 0) return;
                        hasProblems = true;
                        content += `<h6>${p.name} (${problems.length}题)</h6><ul class="list-group list-group-flush mb-3">`;
                        content += problems.map(prob => `<li class="list-group-item d-flex justify-content-between align-items-center">${prob.id}: ${prob.name}<span class="badge bg-primary rounded-pill">${prob.difficulty}</span></li>`).join('');
                        content += '</ul>';
                    });
                    if (!hasProblems) content = '<p class="text-center text-muted">当天没有记录详细的题目信息。</p>';
                    
                    this.elements.detailTitle.textContent = `${date} 题目详情`;
                    this.elements.detailContent.innerHTML = content;
                    this.detailModal.show();
                },
                
                updateAllUI() {
                    this.updateStatistics();
                    this.renderHistoryTable();
                    this.renderAcChart();
                    this.updateWeeklyProgress();
                    this.renderHeatmap();
                },

                updateStatistics() {
                    const now = new Date();
                    const todayStr = now.toISOString().split('T')[0];
                    let grand = 0;
                    this.state.records.forEach(r => grand += Object.values(r.counts || {}).reduce((s, c) => s + c, 0));
                    document.getElementById('grandTotal').textContent = grand;
                },
                
                renderAcChart() {
                    if (this.state.acChartInstance) this.state.acChartInstance.destroy();
                    const recentRecords = this.state.records.slice(-7);
                    
                    const chartOptions = {
                        responsive: true,
                        plugins: { legend: { labels: { color: this.state.currentTheme === 'dark' ? 'white' : 'black' } } },
                        scales: { 
                            x: { stacked: true, ticks: { color: this.state.currentTheme === 'dark' ? 'white' : 'black' } }, 
                            y: { stacked: true, beginAtZero: true, ticks: { color: this.state.currentTheme === 'dark' ? 'white' : 'black' } }
                        }
                    };

                    this.state.acChartInstance = new Chart(this.elements.acChartCanvas, {
                        type: 'bar',
                        data: {
                            labels: recentRecords.map(r => r.date.substring(5)),
                            datasets: Object.entries(this.platforms).map(([id, p]) => ({
                                label: p.name,
                                data: recentRecords.map(r => r.counts?.[id] || 0),
                                backgroundColor: p.color,
                            }))
                        },
                        options: chartOptions
                    });
                },
                
                renderPlatformPieChart() {
                    if (this.state.platformChartInstance) this.state.platformChartInstance.destroy();
                    const platformCounts = Object.keys(this.platforms).reduce((acc, id) => ({...acc, [this.platforms[id].name]: 0}), {});

                    this.state.records.forEach(r => {
                        Object.keys(this.platforms).forEach(id => {
                            platformCounts[this.platforms[id].name] += r.counts?.[id] || 0;
                        });
                    });
                    const chartData = Object.entries(platformCounts).filter(([, count]) => count > 0);
                    
                    this.state.platformChartInstance = new Chart(this.elements.platformChartCanvas, {
                        type: 'pie',
                        data: {
                            labels: chartData.map(([name]) => name),
                            datasets: [{
                                data: chartData.map(([, count]) => count),
                                backgroundColor: Object.values(this.platforms).map(p => p.color),
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'top', labels: { color: this.state.currentTheme === 'dark' ? 'white' : 'black' } },
                                tooltip: {
                                    callbacks: {
                                        label: ctx => {
                                            const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = total > 0 ? Math.round((ctx.raw / total) * 100) : 0;
                                            return `${ctx.label}: ${ctx.raw}题 (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                },
                
                toggleTheme() {
                    this.state.currentTheme = this.state.currentTheme === 'light' ? 'dark' : 'light';
                    this.setTheme(this.state.currentTheme);
                    this.saveData();
                },

                setTheme(theme) {
                    this.elements.body.dataset.theme = theme;
                    const btn = document.getElementById('themeToggleBtn');
                    btn.innerHTML = theme === 'light' 
                        ? '<i class="bi bi-moon-stars-fill"></i>' 
                        : '<i class="bi bi-brightness-high-fill"></i>';
                    btn.className = theme === 'light' ? 'btn btn-dark' : 'btn btn-light';
                    this.updateAllUI(); // Re-render charts for new theme
                },

                editWeeklyGoal() {
                    const newGoal = prompt('请输入新的每周刷题目标:', this.state.weeklyGoal);
                    if (newGoal && !isNaN(newGoal) && newGoal > 0) {
                        this.state.weeklyGoal = parseInt(newGoal);
                        this.saveData();
                        this.updateWeeklyProgress();
                    }
                },
                
                updateWeeklyProgress() {
                    const now = new Date();
                    const dayOfWeek = now.getDay() === 0 ? 6 : now.getDay() - 1; // Mon = 0
                    const startOfWeek = new Date(now.setDate(now.getDate() - dayOfWeek));
                    
                    let weeklyCount = 0;
                    for (let i = 0; i < 7; i++) {
                        const date = new Date(startOfWeek);
                        date.setDate(startOfWeek.getDate() + i);
                        const dateStr = date.toISOString().split('T')[0];
                        const record = this.state.records.find(r => r.date === dateStr);
                        if (record) {
                            weeklyCount += Object.values(record.counts || {}).reduce((s, c) => s + c, 0);
                        }
                    }
                    
                    const percentage = Math.min(100, (weeklyCount / this.state.weeklyGoal) * 100);
                    this.elements.weeklyProgressBar.style.width = `${percentage}%`;
                    this.elements.weeklyProgressBar.setAttribute('aria-valuenow', percentage);
                    this.elements.weeklyProgressText.textContent = `${weeklyCount} / ${this.state.weeklyGoal}`;
                },

                renderHeatmap() {
                    this.elements.heatmapContainer.innerHTML = '';
                    const today = new Date();
                    const oneYearAgo = new Date();
                    oneYearAgo.setFullYear(today.getFullYear() - 1);

                    const recordMap = new Map(this.state.records.map(r => [r.date, Object.values(r.counts || {}).reduce((s, c) => s + c, 0)]));
                    
                    for (let d = oneYearAgo; d <= today; d.setDate(d.getDate() + 1)) {
                        const dateStr = d.toISOString().split('T')[0];
                        const count = recordMap.get(dateStr) || 0;
                        let level = 0;
                        if (count > 0) level = 1;
                        if (count >= 3) level = 2;
                        if (count >= 7) level = 3;
                        if (count >= 15) level = 4;
                        
                        const dayDiv = document.createElement('div');
                        dayDiv.className = 'heatmap-day';
                        dayDiv.dataset.level = level;
                        dayDiv.title = `${dateStr}: ${count} 题`;
                        this.elements.heatmapContainer.appendChild(dayDiv);
                    }
                    // Use bootstrap tooltips for heatmap
                    Array.from(this.elements.heatmapContainer.children).forEach(el => new bootstrap.Tooltip(el));
                },

                exportData() {
                    const dataStr = JSON.stringify({
                        records: this.state.records,
                        weeklyGoal: this.state.weeklyGoal,
                        theme: this.state.currentTheme
                    }, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `lege_oj_records_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                },
                
                importData(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = e => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (data.records && Array.isArray(data.records)) {
                                this.state.records = data.records;
                                this.state.weeklyGoal = data.weeklyGoal || 10;
                                this.state.currentTheme = data.theme || 'light';
                                this.saveData();
                                this.setTheme(this.state.currentTheme);
                                this.updateAllUI();
                                this.loadRecordForDate();
                                alert('数据导入成功!');
                            } else {
                                alert('导入失败：文件格式不正确。');
                            }
                        } catch (error) {
                            alert(`导入失败：${error.message}`);
                        }
                    };
                    reader.readAsText(file);
                    event.target.value = ''; // Reset file input
                },

                initParticles() {
                    particlesJS('particles-js', {
                        "particles": {"number":{"value":80,"density":{"enable":true,"value_area":800}},"color":{"value":"#888888"},"shape":{"type":"circle"},"opacity":{"value":0.5,"random":false},"size":{"value":3,"random":true},"line_linked":{"enable":true,"distance":150,"color":"#888888","opacity":0.4,"width":1},"move":{"enable":true,"speed":2,"direction":"none","random":false,"straight":false,"out_mode":"out","bounce":false}},
                        "interactivity": {"detect_on":"canvas","events":{"onhover":{"enable":true,"mode":"repulse"},"onclick":{"enable":true,"mode":"push"},"resize":true}},
                        "retina_detect": true
                    });
                    // Adjust particle color for dark mode
                    if (this.state.currentTheme === 'dark') {
                        if (window.pJSDom && window.pJSDom[0]) {
                            const pJS = window.pJSDom[0].pJS;
                            pJS.particles.color.value = '#ffffff';
                            pJS.particles.line_linked.color = '#ffffff';
                            pJS.fn.particlesRefresh();
                        }
                    }
                }
            };
            
            // 启动应用
            OJ_Tracker.init();
        });
    </script>
</body>
</html>
